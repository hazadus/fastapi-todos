x-postgres-base: &postgres-base
  image: postgres:16
  restart: always
  healthcheck:
    test:
      - CMD-SHELL
      - pg_isready -U postgres
    interval: 10s
    timeout: 5s
    retries: 5

services:
  # MARK: DEV
  app-dev:
    container_name: app-dev
    profiles: ["dev"]
    build:
      context: ./backend
      args:
        ENV: dev
    env_file: "./backend/.env.dev"
    command: ["uvicorn", "app.main:app", "--reload", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - 8000:8000
    volumes:
      - ./backend/app/:/app/app/
      - ./backend/migrations/versions/:/app/migrations/versions/
    depends_on:
      postgres-dev:
        condition: service_healthy
    networks:
      - dev

  postgres-dev:
    profiles: ["dev"]
    <<: *postgres-base
    container_name: postgres-dev
    env_file: "./backend/.env.dev"
    environment:
      - POSTGRES_HOST=postgres-dev
    ports:
      - 5432:5432
    volumes:
      - ./data/postgres/:/var/lib/postgresql/data
    networks:
      - dev

#MARK: Networks
networks:
  dev: